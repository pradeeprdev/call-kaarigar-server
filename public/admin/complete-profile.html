<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Admin Profile - Call Kaarigar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .profile-header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .profile-photo-container {
            position: relative;
            width: 150px;
            height: 150px;
            margin: 0 auto;
        }
        .profile-photo {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 4px solid white;
            object-fit: cover;
            background-color: #fff;
        }
        .form-section {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .photo-upload-btn {
            position: absolute;
            bottom: 0;
            right: 0;
            background: #3498db;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .photo-upload-btn:hover {
            background: #2980b9;
            transform: scale(1.1);
        }
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
            background-color: #28a745; /* Green for active/admin */
            color: white;
        }
        #responseMessage {
            display: none;
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem; /* Added for spacing */
        }
        #responseMessage.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        #responseMessage.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body class="bg-light">
    <div class="profile-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-4 text-center">
                    <div class="profile-photo-container">
                        <img src="/assets/default-admin.jpg" alt="Admin Photo" class="profile-photo" id="profilePhoto">
                    </div>
                </div>
                <div class="col-md-8 d-flex justify-content-between align-items-start">
                    <div class="d-flex flex-column">
                        <div class="mb-3">
                            <h2 class="mb-1" id="usernamePlaceholder">Loading...</h2>
                            <div class="status-badge">
                                <i class="fas fa-shield-alt me-2"></i>Administrator
                            </div>
                        </div>
                        <div>
                            <p class="mb-2">
                                <i class="fas fa-envelope me-2"></i><span id="emailPlaceholder">Loading...</span>
                            </p>
                            <p class="mb-2">
                                <i class="fas fa-phone me-2"></i><span id="phonePlaceholder">Loading...</span>
                            </p>
                            <p class="mb-0">
                                <i class="fas fa-briefcase me-2"></i><span id="designationPlaceholder">Loading...</span>
                            </p>
                        </div>
                    </div>
                    <div class="d-flex flex-column align-items-end">
                        <button onclick="logout()" class="btn btn-danger mb-2">
                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mb-5">
        <div id="responseMessage" class="alert" style="display: none;"></div>
        
        <form id="adminProfileForm" class="needs-validation" novalidate>
            <!-- Personal Information & Photo Upload -->
            <div class="form-section">
                <h3 class="mb-4">Personal Information</h3>
                <div class="row g-3">
                    <div class="col-12 text-center mb-4">
                        <div class="profile-photo-container">
                            <img id="profilePreview" src="/uploads/admin/default-admin.jpg" class="profile-photo" alt="Profile Photo">
                            <label for="photo" class="btn btn-primary btn-sm position-absolute bottom-0 end-0">
                                <i class="fas fa-camera"></i> <!-- Camera icon for photo upload -->
                            </label>
                            <input type="file" id="photo" name="photo" accept="image/*" class="d-none">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-control" id="username" name="username" required>
                        <div class="invalid-feedback">Please enter a username.</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Designation</label>
                        <input type="text" class="form-control" id="designation" name="designation" required>
                        <div class="invalid-feedback">Please enter your designation.</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" name="email" readonly>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-control" id="phone" name="phone" readonly>
                    </div>
                </div>
            </div>

            <!-- Permissions -->
            <div class="form-section">
                <h3 class="mb-4">Administrative Permissions</h3>
                <div class="row" id="permissionsContainer">
                    <div class="col-md-4 mb-3">
                        <div class="permission-card active" data-permission="manage_users">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="perm_users" checked disabled>
                                <label class="form-check-label fw-bold" for="perm_users">
                                    Manage Users
                                </label>
                            </div>
                            <small class="text-muted d-block mt-2">
                                View and manage user accounts, profiles, and access controls
                            </small>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="permission-card" data-permission="manage_services">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="perm_services">
                                <label class="form-check-label fw-bold" for="perm_services">
                                    Manage Services
                                </label>
                            </div>
                            <small class="text-muted d-block mt-2">
                                Create, edit, and manage service categories and offerings
                            </small>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="permission-card" data-permission="manage_bookings">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="perm_bookings">
                                <label class="form-check-label fw-bold" for="perm_bookings">
                                    Manage Bookings
                                </label>
                            </div>
                            <small class="text-muted d-block mt-2">
                                Monitor and manage service bookings and appointments
                            </small>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="permission-card" data-permission="manage_payments">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="perm_payments">
                                <label class="form-check-label fw-bold" for="perm_payments">
                                    Manage Payments
                                </label>
                            </div>
                            <small class="text-muted d-block mt-2">
                                Handle payment processing and financial transactions
                            </small>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="permission-card" data-permission="manage_reports">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="perm_reports">
                                <label class="form-check-label fw-bold" for="perm_reports">
                                    Manage Reports
                                </label>
                            </div>
                            <small class="text-muted d-block mt-2">
                                Access and generate system reports and analytics
                            </small>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="permission-card" data-permission="manage_settings">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="perm_settings">
                                <label class="form-check-label fw-bold" for="perm_settings">
                                    Manage Settings
                                </label>
                            </div>
                            <small class="text-muted d-block mt-2">
                                Configure system settings and preferences
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security Settings -->
            <div class="form-section">
                <h3 class="mb-4">Security Settings</h3>
                <div class="row g-3">
                    <div class="col-12">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="twoFactorAuth">
                            <label class="form-check-label" for="twoFactorAuth">Enable Two-Factor Authentication</label>
                        </div>
                    </div>
                    <div class="col-12">
                        <button type="button" class="btn btn-outline-primary" onclick="changePassword()">
                            <i class="fas fa-key me-2"></i>Change Password
                        </button>
                    </div>
                </div>
            </div>

            <div class="text-center">
                <button type="submit" class="btn btn-primary btn-lg px-5">Save Changes</button>
            </div>
        </form>
    </div>

    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Change Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label class="form-label">Current Password</label>
                            <input type="password" class="form-control" id="currentPassword" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirmPassword" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitPasswordChange()">Change Password</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Handle permission card clicks
        document.querySelectorAll('.permission-card').forEach(card => {
            card.addEventListener('click', function() {
                const checkbox = this.querySelector('input[type="checkbox"]');
                if (!checkbox.disabled) {
                    checkbox.checked = !checkbox.checked;
                    this.classList.toggle('active');
                }
            });
        });

        // Load user data
        async function loadAdminProfile() {
            try {
                const response = await fetch('/api/admin/profile', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load profile data');
                }

                const data = await response.json();
                if (data.success && data.data) {
                    const profile = data.data;
                    // Update header info with proper formatting
                    document.getElementById('usernamePlaceholder').textContent = profile.name || 'Admin';
                    document.getElementById('emailPlaceholder').textContent = profile.email || 'Not provided';
                    document.getElementById('phonePlaceholder').textContent = profile.phone || 'Not provided';
                    document.getElementById('designationPlaceholder').textContent = profile.designation || 'Not specified';
                    
                    // Update form fields
                    document.getElementById('username').value = profile.name || '';
                    document.getElementById('designation').value = profile.designation || '';
                    document.getElementById('email').value = profile.email || '';
                    document.getElementById('phone').value = profile.phone || '';

                    // Set permissions
                    if (profile.permissions) {
                        profile.permissions.forEach(permission => {
                            const checkbox = document.querySelector(`input[id="perm_${permission.split('_')[1]}"]`);
                            if (checkbox) {
                                checkbox.checked = true;
                                checkbox.closest('.permission-card').classList.add('active');
                            }
                        });
                    }

                    // Set profile photo if available
                    if (profile.profilePhotoUrl) {
                        document.getElementById('profilePhoto').src = profile.profilePhotoUrl;
                        document.getElementById('profilePreview').src = profile.profilePhotoUrl;
                    }
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                alert('Failed to load profile data');
            }
        }
        // Form submission
        document.getElementById('adminProfileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!this.checkValidity()) {
                e.stopPropagation();
                this.classList.add('was-validated');
                return;
            }

            const permissions = Array.from(document.querySelectorAll('.permission-card input[type="checkbox"]:checked'))
                .map(checkbox => checkbox.closest('.permission-card').dataset.permission);
            
            const photoFile = document.getElementById('photo').files[0]; // Get the file input
            let requestBody;
            let headers = {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            };

            if (photoFile) {
                // If there's a photo, use FormData
                requestBody = new FormData();
                requestBody.append('name', document.getElementById('username').value);
                requestBody.append('designation', document.getElementById('designation').value);
                requestBody.append('permissions', JSON.stringify(permissions));
                requestBody.append('twoFactorAuth', document.getElementById('twoFactorAuth').checked);
                requestBody.append('profilePhoto', photoFile);
            } else {
                // If no photo, use JSON
                requestBody = {
                name: document.getElementById('username').value, // Changed from username to name
                designation: document.getElementById('designation').value,
                permissions: permissions, // Array of permissions
                securitySettings: { // Assuming this structure for security settings
                    twoFactorAuth: document.getElementById('twoFactorAuth').checked // Boolean
                }
            }
            }

            try {
                if (!photoFile) {
                    headers['Content-Type'] = 'application/json';
                }

                const response = await fetch('/api/admin/profile', {
                    method: 'PUT', // Use PUT for updating a resource
                    headers: headers,
                    body: requestBody
                });

                if (!response.ok) {
                    throw new Error('Failed to update profile');
                }

                const result = await response.json();
                alert('Profile updated successfully!');
                window.location.href = '/admin/dashboard';
            } catch (error) {
                alert('Error updating profile: ' + error.message);
            }
        });

        // Change password modal
        function changePassword() {
            const modal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
            modal.show();
        }

        async function submitPasswordChange() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                alert('New passwords do not match!');
                return;
            }

            try {
                const response = await fetch('/api/admin/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        currentPassword,
                        newPassword
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to change password');
                }

                alert('Password changed successfully!');
                bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
                document.getElementById('changePasswordForm').reset();
            } catch (error) {
                alert('Error changing password: ' + error.message);
            }
        }

        // Photo preview logic
        document.getElementById('photo').addEventListener('change', function(event) {
            const [file] = event.target.files;
            if (file) {
                document.getElementById('profilePreview').src = URL.createObjectURL(file);
                // Also update the header photo if it's different
                document.getElementById('profilePhoto').src = URL.createObjectURL(file);
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', loadAdminProfile);

        // Logout function
        async function logout() {
            try {
                console.log('Logging out...');
                
                // Call the backend logout endpoint
                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const data = await response.json();
                console.log('Logout response:', data);

                // Clear the authentication token
                localStorage.removeItem('token');
                console.log('Token removed from localStorage');

                // Use the redirect URL from the server response, or fallback to /auth/login
                const redirectUrl = data.data?.redirectTo || '/auth/login';
                console.log('Redirecting to:', redirectUrl);
                window.location.href = redirectUrl;
                
            } catch (error) {
                console.error('Logout error:', error);
                // Even if there's an error, still remove token and redirect
                localStorage.removeItem('token');
                window.location.href = '/auth/login';
            }
        }
    </script>
</body>
</html>
