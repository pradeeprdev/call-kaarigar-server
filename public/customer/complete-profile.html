<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Profile - Call Kaarigar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .profile-header {
            background: linear-gradient(135deg, #4a90e2, #7b64ff);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .profile-photo-container {
            position: relative;
            width: 150px;
            height: 150px;
            margin: 0 auto;
        }
        .profile-photo {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 4px solid white;
            object-fit: cover;
        }
        .photo-edit-btn {
            position: absolute;
            bottom: 0;
            right: 0;
            background: white;
            border-radius: 50%;
            padding: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .form-section {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .preferences-toggle {
            width: 60px;
            height: 30px;
        }
    </style>
</head>
<body class="bg-light">
    <div class="profile-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-4 text-center">
                    <div class="profile-photo-container">
                        <img src="/assets/default-profile.jpg" alt="Profile Photo" class="profile-photo" id="profilePhoto">
                        <button class="btn btn-light btn-sm photo-edit-btn" onclick="document.getElementById('photoInput').click()">
                            <i class="fas fa-camera"></i>
                        </button>
                        <input type="file" id="photoInput" hidden accept="image/*">
                    </div>
                </div>
                <div class="col-md-8 d-flex justify-content-between">
                    <div>
                        <h2 id="usernamePlaceholder">Loading...</h2>
                        <p class="mb-0"><i class="fas fa-envelope me-2"></i><span id="emailPlaceholder">Loading...</span></p>
                        <p><i class="fas fa-phone me-2"></i><span id="phonePlaceholder">Loading...</span></p>
                    </div>
                    <div>
                        <button onclick="logout()" class="btn btn-danger">
                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mb-5">
        <form id="profileForm" class="needs-validation" novalidate>
            <!-- Personal Information -->
            <div class="form-section">
                <h3 class="mb-4">Personal Information</h3>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="fullName" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Bio</label>
                        <textarea class="form-control" id="bio" rows="3" maxlength="500" placeholder="Tell us about yourself..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Address Information -->
            <div class="form-section">
                <h3 class="mb-4">Address Information</h3>
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label">Address Line</label>
                        <input type="text" class="form-control" id="addressLine" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">City</label>
                        <input type="text" class="form-control" id="city" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">State</label>
                        <select class="form-select" id="state" required>
                            <option value="">Select State</option>
                            <!-- Indian states will be populated via JavaScript -->
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Postal Code</label>
                        <input type="text" class="form-control" id="postalCode" required pattern="[0-9]{6}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Country</label>
                        <input type="text" class="form-control" id="country" value="India" readonly>
                    </div>
                </div>
            </div>

            <!-- Preferences -->
            <div class="form-section">
                <h3 class="mb-4">Preferences</h3>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Preferred Language</label>
                        <select class="form-select" id="language">
                            <option value="en">English</option>
                            <option value="hi">Hindi</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Currency</label>
                        <input type="text" class="form-control" id="currency" value="INR" readonly>
                    </div>
                    <div class="col-12">
                        <div class="form-check form-switch">
                            <input class="form-check-input preferences-toggle" type="checkbox" id="notificationsEnabled">
                            <label class="form-check-label" for="notificationsEnabled">Enable Notifications</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center">
                <button type="submit" class="btn btn-primary btn-lg px-5">Save Profile</button>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // List of Indian states
        const indianStates = [
            'Andhra Pradesh', 'Arunachal Pradesh', 'Assam', 'Bihar', 'Chhattisgarh', 'Goa', 'Gujarat', 'Haryana',
            'Himachal Pradesh', 'Jharkhand', 'Karnataka', 'Kerala', 'Madhya Pradesh', 'Maharashtra', 'Manipur',
            'Meghalaya', 'Mizoram', 'Nagaland', 'Odisha', 'Punjab', 'Rajasthan', 'Sikkim', 'Tamil Nadu',
            'Telangana', 'Tripura', 'Uttar Pradesh', 'Uttarakhand', 'West Bengal'
        ];

        // Populate states dropdown
        const stateSelect = document.getElementById('state');
        indianStates.forEach(state => {
            const option = document.createElement('option');
            option.value = state;
            option.textContent = state;
            stateSelect.appendChild(option);
        });

        // Handle profile photo upload
        document.getElementById('photoInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('profilePhoto').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Form submission
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!this.checkValidity()) {
                e.stopPropagation();
                this.classList.add('was-validated');
                return;
            }

            const formData = {
                fullName: document.getElementById('fullName').value,
                username: document.getElementById('username').value,
                bio: document.getElementById('bio').value,
                address: {
                    addressLine: document.getElementById('addressLine').value,
                    city: document.getElementById('city').value,
                    state: document.getElementById('state').value,
                    postalCode: document.getElementById('postalCode').value,
                    country: document.getElementById('country').value
                },
                preferences: {
                    language: document.getElementById('language').value,
                    notifications: document.getElementById('notificationsEnabled').checked
                }
            };

            try {
                const response = await fetch('/api/customer/profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    throw new Error('Failed to update profile');
                }

                const result = await response.json();
                alert('Profile updated successfully!');
                window.location.href = '/customer/dashboard';
            } catch (error) {
                alert('Error updating profile: ' + error.message);
            }
        });

        // Load user data
        async function loadUserData() {
            try {
                const response = await fetch('/api/customer/profile', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load profile data');
                }

                const data = await response.json();
                if (data.success && data.data) {
                    const profile = data.data;
                    document.getElementById('usernamePlaceholder').textContent = profile.username;
                    document.getElementById('emailPlaceholder').textContent = profile.email;
                    document.getElementById('phonePlaceholder').textContent = profile.phoneNumber;
                    document.getElementById('fullName').value = profile.fullName || '';
                    document.getElementById('username').value = profile.username || '';
                    document.getElementById('bio').value = profile.bio || '';
                    if (profile.photo) {
                        document.getElementById('profilePhoto').src = profile.photo;
                    }
                    if (profile.address) {
                        document.getElementById('addressLine').value = profile.address.addressLine || '';
                        document.getElementById('city').value = profile.address.city || '';
                        document.getElementById('state').value = profile.address.state || '';
                        document.getElementById('postalCode').value = profile.address.postalCode || '';
                    }
                    if (profile.preferences) {
                        document.getElementById('language').value = profile.preferences.language || 'en';
                        document.getElementById('notificationsEnabled').checked = profile.preferences.notifications !== false;
                    }
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                alert('Failed to load profile data');
            }
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', loadUserData);

        // Logout function
        async function logout() {
            try {
                // Get the token
                const token = localStorage.getItem('token');
                
                if (token) {
                    // Call the backend logout endpoint
                    const response = await fetch('/api/auth/logout', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Logout failed');
                    }
                }
            } catch (error) {
                console.error('Logout error:', error);
            } finally {
                // Always clear local storage and redirect, even if the server call fails
                localStorage.clear(); // Clear all auth data
                window.location.href = '/auth/login';
            }
        }
    </script>
</body>
</html>
